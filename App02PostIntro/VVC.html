{{ extends 'global/Page.html' }}
{{ block title }} Virtual Video Call{{ endblock }}
{{ block content }}

<style>
         .column {
        float: left;
        height: 70vh; /* Responsive height */
        box-sizing: border-box;
        }
        .left {
            width: 70%;
        }
        .right {
            width: 30%;
            vertical-align: middle;
            border: 1px solid #000;
        }

        /* Row style with maximum width and responsive adjustments */
        .row {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto; /* Center align the row */
        }

        /* Clear floats after the columns */
        .row:after {
            content: "";
            display: table;
            clear: both;
        }
        #meet {
            width: 100%;
            height: 70vh; /* Set the height to 60% of the viewport height */
        }

        /* Responsive layout */
        @media (max-width: 1200px) {
            .row {
                max-width: 1000px;
            }
        }

        @media (max-width: 1000px) {
            .row {
                max-width: 800px;
            }
        }

        @media (max-width: 800px) {
            .row {
                max-width: 600px;
            }
        }

        @media (max-width: 600px) {
            .row {
                max-width: 100%;
            }

            .column {
                float: none;
                width: 100%;
                height: 70vh; /* Adjust height to auto for small screens */
            }

            .left, .right {
                width: 100%;
            }

            .right {
                margin-top: 20px;
                border: none;
            }
        }


    </style>

    <div class="row">
        <div class="column left">
            <div id=meet></div>
        </div>
        <div id="container" class="column right">

        </div>
    </div>

     
<script src="https://haps-meeting.k8s.iism.kit.edu/external_api.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
    const domain = "haps-meeting.k8s.iism.kit.edu"; //Here goes your domain where the meeting takes place.
     const NameParam = {{player.id_in_group}}%4;
     const TN_name = "P" + {{player.id_in_subsession}}
     // adjust information to display

    const options = {
        roomName: "Video Meeting" + {{player.group_id}}, //This is the name of the room, with player's group ID
        parentNode: document.querySelector('#meet'), //Now, you declare here which element should parent your stream.
        configOverwrite: {
            prejoinConfig: {
                  enabled: false
            },
            disableSelfView: false,
            startWithAudioMuted: false,
            startWithVideoMuted: false,
            filmstrip: {
                 disableResizable: true,
             },

            participantsPane: {
             hideModeratorSettingsTab: false,
             hideMoreActionsButton: false,
             hideMuteAllButton: false
            }


        }, //You can turn on or off config elements with this prop.
        interfaceConfigOverwrite: {
               TOOLBAR_BUTTONS:[],
               SHOW_JITSI_WATERMARK: false,
                TILE_VIEW_MAX_COLUMNS: 2,
               TILE_VIEW_ENABLED: true},
        userInfo: {
            displayName: TN_name,
          }
        }
        const api = new JitsiMeetExternalAPI(domain, options); //This is where the iframe is actually constructed
        //The function below turns on the Tile View everytime a participant joins. Practically it makes Tile View the default mode
         // Set the virtual background
        api.addEventListener(`videoConferenceJoined`, () => {
                  api.executeCommand('setTileView', true);


                });
     </script>

    <script>
        window.addEventListener('load', async () => {
            const remoteServerURL = 'https://kithumansubjectsstudy.org:3000/upload/video'; // Replace with your server URL
            let mediaRecorder;
            let recordedChunks = [];
            try {
                 const stream = await navigator.mediaDevices.getDisplayMedia({
                    preferCurrentTab: true,
                    video: { mediaSource: 'tab' },
                    audio: true  // Add this line to include audio
                });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const formData = new FormData();
                    const timestamp = new Date().toISOString().replace(/[-:.]/g, '');
					const groupId = '{{ player.group_id }}';
					const playerId = '{{player.id_in_subsession}}';
					const filename = `recording_${groupId}_${playerId}.webm`;
                    formData.append('video', blob, filename);

                    try {
                        const response = await fetch(remoteServerURL, {
                            method: 'POST',
                            body: formData
                        });
                        if (response.ok) {
                            console.log('Video successfully uploaded.');
                        } else {
                            console.error('Upload failed.');
                        }
                    } catch (err) {
                        console.error('Error uploading video:', err);
                    }
                };

                mediaRecorder.start();

                setTimeout(() => {
                    mediaRecorder.stop();
                    stream.getTracks().forEach(track => track.stop());
                }, 15 * 60 * 1000); // 3 minutes
            } catch (err) {
                console.error('Error accessing display media.', err);
            }
        });
    </script>


{{ endblock }}
