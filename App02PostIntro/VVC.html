{{ extends 'global/Page.html' }}
{{ block title }} Virtual Video Call{{ endblock }}
{{ block content }}

<style>
        * {
            box-sizing: border-box;
        }

        .row {
            width: 1200px;
        }

        /* Create two unequal columns that floats next to each other */
        .column {
            float: left;
            height: 700px;
        }
        .left {
            width: 70%;
        }
        .right {
            width: 30%;
            vertical-align: middle;
            border: 1px solid #000;
        }

        /* Clear floats after the columns */
        .row:after {
            content: "";
            display: table;
            clear: both;
        }
    </style>

   <div class="row">
        <div class="column left">
            <p><b>Please now select your video background.</b> You can just <b>choose any of the provided options as they are all the same image.</b>
                Once all group members have selected an image, the video meeting will start. </p>
            <div id=meet></div>
        </div>
        <div id="container" class="column right">
        </div>
    </div>

     
<script src="https://haps-meeting.k8s.iism.kit.edu/external_api.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>

<script>
    const domain = "haps-meeting.k8s.iism.kit.edu"; //Here goes your domain where the meeting takes place.
    var isStreamOn = false;
     const NameParam = {{player.id_in_group}}%4;
     const TN_name = "P" + {{player.id_in_subsession}}
     // adjust information to display
      /*  switch (NameParam) {
          case 0:
            TN_name = "Participant 1";
            break;
          case 1:
            TN_name = "Participant 2";
            break;
          case 2:
            TN_name = "Participant 3";
            break;
          case 3:
            TN_name = "Participant 4";
            break;
          default:
            TN_name = "Participant";
        }*/
    const options = {
        roomName: "Video Meeting" + {{player.group_id}}, //This is the name of the room.

        height: 700,                //Same as above, just vertical.
        parentNode: document.querySelector('#meet'), //Now, you declare here which element should parent your stream.
        configOverwrite: {
          //  fileRecordingsEnabled =true,
            //fileRecordingsServiceEnabled =true,
          //  useHostPageLocalStorage = true,
            prejoinConfig: {
                  enabled: false
            },
            disableSelfView: false,
            startWithAudioMuted: false,
            startWithVideoMuted: false,
            filmstrip: {
                 disableResizable: true,
             },
             recordings: {
                 recordAudioAndVideo: true,
                 suggestRecording: false,
                 showPrejoinWarning: false
             },
             screenshotCapture: {
                   enabled: true,
                    mode: 'always'
            },
            participantsPane: {
             hideModeratorSettingsTab: false,
             hideMoreActionsButton: false,
             hideMuteAllButton: false
            },

            transcription: {
                enabled: true,
                translationLanguages: ['en-US', 'es'],
                useAppLanguage: false,
                preferredLanguage: 'en-US',
                autoTranscribeOnRecord: true
            },
            fileRecordingsEnabled: true,
            localRecording: {
                 disable: false,
                 notifyAllParticipants: false
            }


        }, //You can turn on or off config elements with this prop.
        interfaceConfigOverwrite: {
               TOOLBAR_BUTTONS:[],
               SHOW_JITSI_WATERMARK: false,
               SHOW_MEETING_NAME: false,
                SHOW_MEETING_TIMER: false},
        userInfo: {
            displayName: TN_name,
          }
        }
        const api = new JitsiMeetExternalAPI(domain, options); //This is where the iframe is actually constructed
        //The function below turns on the Tile View everytime a participant joins. Practically it makes Tile View the default mode
        api.addEventListener(`videoConferenceJoined`, () => {
                setTimeout(() => {
                        api.executeCommand('toggleVirtualBackgroundDialog');
                    }, 2000);

                setTimeout(() => {
                    html2canvas(document.querySelector('#meet')).then(canvas => {
                        // You can now display or save the canvas as an image
                        document.body.appendChild(canvas);

                        // To save as an image
                        var image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
                        var link = document.createElement('a');

                        // Set the download attribute with a default file name
                         link.download = {{player.group_id}}+"_"+
                                + {{player.id_in_subsession}} + '.png';

                         // Set the href attribute to the image data URL
                         link.href = image;

                        // Programmatically click the link to trigger the download
                        link.click();
                    });
                }, 15000); // Adjust time as necessary for the video streams to appear

                const listener = ({ enabled }) => {
                    api.removeEventListener(`tileViewChanged`, listener);
                    if (!enabled) {
                        api.executeCommand(`toggleTileView`);
                    }
                };
    });

        const fs = require('fs');
        const path = require('path');

        function createDirIfNotExists(dirPath) {
            if (!fs.existsSync(dirPath)) {
                fs.mkdirSync(dirPath, { recursive: true });
                console.log(`Directory created: ${dirPath}`);
            } else {
                console.log(`Directory already exists: ${dirPath}`);
            }
        }



    function streamHandler() {
        try {
            if (!isStreamOn) {
                document.getElementById("streamingResponseMsg").innerHTML = "Starting streaming...";
                //The function below starts the stream or recording, according to its "mode"
                api.executeCommand('startRecording', {
                    mode: 'stream', //recording mode, either `file` or `stream`.
                    rtmpStreamKey: '', //This where you *should* put your favoured rtmp stream server along with your key, like "rtmp:\/\/some.address/norecord/stream-key"
                    youtubeStreamKey: 'rtmp:\/\/some.address/norecord/stream-key', //the youtube stream key.
                });
            } else {
                document.getElementById("streamingResponseMsg").innerHTML = "Stopping streaming...";
                //The function below stops the stream or recording, according to the string you pass. Official guide shows an object, while it should be a string
                api.executeCommand('stopRecording', 'stream');
            }

        }
        catch (e){
            if (isStreamOn){
                document.getElementById("streamingResponseMsg").innerHTML = "Error while stopping stream.";
                console.log("Exception while stopping stream.", e);
            }else{
                document.getElementById("streamingResponseMsg").innerHTML = "Error while starting stream.";
                console.log("Exception while starting stream.", e);

            }
            this.isStreamOn = false;
         }
    };
        //This part doesn't work without making some changes to the code as per this; https://github.com/team-ai-repo/jitsi-meet/pull/4/files
        api.addEventListener("recordingStarted", () => {
        document.getElementById("stream-btn").innerHTML="Stop Streaming";
        document.getElementById("streamingResponseMsg").innerHTML = "Stream is on";
        this.isStreamOn = true;
        console.log("Example Stream On", this.isStreamOn);
        });

        api.addEventListener("recordingStopped", () => {
        document.getElementById("stream-btn").innerHTML="Start Streaming";
        document.getElementById("streamingResponseMsg").innerHTML = "Stream is off";
        console.log("Example Stream Off", this.isStreamOn);
        this.isStreamOn = false;
    });
</script>

{{ endblock }}
